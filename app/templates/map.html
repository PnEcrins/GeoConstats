{% extends "base.html" %}
{% block content %}
	<center><h1>Constats dans le Parc national des Ecrins</h1></center>
	<div id="liste" class="leftMap">
		<form action="{{url_for('map')}}" method="GET" novalidate>
			<div class="form-group">
				Type d'animaux <br>
				{{ form.animaux(size=4) }}
				{% for error in form.animaux.errors %}
				<span style="color: red;">[{{ error }}]</span>
				{% endfor %}
			</div>		
			<div class="form-group">
				Année du constat <br>
				{{ form.date(size=18) }}
				{% for error in form.date.errors %}
				<span style="color: red;">[{{ error }}]</span>
				{% endfor %}
			</div>
			<div class="form-group">
				Statut du constat <br>
				{{ form.statut(size=4) }}
				{% for error in form.statut.errors %}
				<span style="color: red;">[{{ error }}]</span>
				{% endfor %}
			</div>
			<div><button id="subform" type="submit" class="btn btn-primary">Filtrer</button></div>
			<div><button id="download" onclick="window.location.href='{{url_for('download')}}'">Telecharger</button></div>
			<button onclick="downloadFilter()">Telecharger avec filtres</button>
		</form>
		
		{% for constats in Constats %}
			<button class="btn btn-light" data-toggle="collapse" data-target="#textConstat{{constats.properties.id_constat}}" style="margin:10px; display:list-item block;" >{{constats.properties.date_attaque}} {{ constats.properties.type_animaux }}</button>
			<center><div style="vertical-align:middle;"id="textConstat{{constats.properties.id_constat}}" class="collapse">
				Numéro : {{constats.properties.id_constat}} <br>
				Date de l'attaque : {{constats.properties.date_attaque}} <br>
				Date du constat : {{constats.properties.date_constat}}<br>
				Nombre de victimes (morts) : {{ constats.properties.nb_victimes_mort }}<br>
				Nombre de victimes (blessés) : {{ constats.properties.nb_victimes_blesse }}<br>
				Nom du 1er agent recenseur : {{ constats.properties.nom_agent1 }}<br>
				Nom du 2ème agent recenseur : {{ constats.properties.nom_agent2 }}<br>
				Propriétaire : {{ constats.properties.proprietaire }}<br>
				Type d'animaux : {{ constats.properties.type_animaux }}<br>
				Statut : {{ constats.properties.statut }}<br>
				<a href="{{url_for('update',idc=constats.properties.id_constat)}}">Modifier le constat</a><br>
				<a href="{{url_for('delete',idc=constats.properties.id_constat)}}">Supprimer le constat</a><br>				
			</div></center>
			<br>

		{%endfor%}
	</div>
	<div id="map"></div>
	<br>
    <button onclick="changeZoom()">
        Vue sur le parc
    </button>
    <script>
        // CONFIGURATION DE LA CARTE //
        var map = L.map('map').setView([44.8, 6.2], 10);
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map); 
        // ACTIONS SUR LA CARTE
        function changeZoom() {
            map.setZoom(10);
            map.setView([44.8, 6.2]);   
        }     
        var jsonData = [
			{% for constats in Constats %}
				{
				'id_constat':'{{constats.properties.id_constat}}',
				'date_attaque': '{{ constats.properties.date_attaque }}',
				'date_constat': '{{ constats.properties.date_constat }}',
				'nb_victimes_mort': '{{ constats.properties.nb_victimes_mort }}',
				'nb_victimes_blesse': '{{ constats.properties.nb_victimes_blesse }}',
				'nom_agent1': '{{ constats.properties.nom_agent1 }}',
				'nom_agent2': '{{ constats.properties.nom_agent2 }}',
				'proprietaire': '{{ constats.properties.proprietaire }}',
				'type_animaux': '{{ constats.properties.type_animaux }}',
				'statut': '{{ constats.properties.statut }}',
				'geometry': '{{ constats.geometry | tojson}}'
				},
			{% endfor %}
        ]
		var markersCluster = new L.MarkerClusterGroup({
		    iconCreateFunction: function(cluster) {
				return L.divIcon({ 
					html: cluster.getChildCount(), 
					className: 'mycluster', 
					iconSize: null 
				});
			}
		});
		map.addLayer(markersCluster);
        var addMarkers = function(point) {
            var markerC=L.marker([JSON.parse(point.geometry).coordinates[1],JSON.parse(point.geometry).coordinates[0]]) 
				.bindPopup("Constat numéro : "+point.id_constat+"<br>"+ 
					"Date de l'attaque : "+point.date_attaque+"<br>"+ 
				    "Date du constat : "+point.date_constat+"<br>"+ 
					"Nombre de victimes (mort) : "+point.nb_victimes_mort+"<br>"+ 
					"Nombre de victimes (blessé) : "+point.nb_victimes_blesse+"<br>"+ 
					"Nom du 1er agent recenseur : "+point.nom_agent1+"<br>"+ 
					"Nom du 2eme agent recenseur : "+point.nom_agent2+"<br>"+ 
					"Propriétaire : "+point.proprietaire+"<br>"+ 
					"Type d'animaux : "+point.type_animaux+"<br>"+ 
					"Statut : "+point.statut+"<br>" 
					) ;
					
				markersCluster.addLayer(markerC); 
        };
        jsonData.forEach(addMarkers);

		function downloadFilter(){

			var queryString=window.location.search;
			var urlParams=new URLSearchParams(queryString)
			var entries=urlParams.entries()
			for (const entry of entries){
				eval(entry[0] + " = " + entry[1])
			}
			console.log(date)
			window.location.href="{{url_for('download',annee=date)}}"
		}


		

	</script>
{% endblock %}