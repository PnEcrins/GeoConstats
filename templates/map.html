{% extends "base.html" %}
{% block content %}
<div id="bloc">
	<div id="liste" class="leftMap">
		<h1>Constats</h1>
		<button data-toggle="collapse" name="filtre" data-target="#filter" class="btn btn-primary">
			<i class="fa fa-filter" aria-hidden="true"></i>			
			Filtrer
		</button>
		 <a class="btn btn-success" href="{{ url_for('routes.form') }}"> 
			<i class="fa fa-plus" aria-hidden="true"></i>
			Ajouter un constat
		</a>
		<br>
		<form method="GET" novalidate class="collapse" id="filter">
			<div class="form-group">
				Année du constat <br>
				{{ form.date(size=1, class_="form-control") }}
			</div>			
			<div class="form-group">
				Type d'animaux <br>
				{{ form.animaux(size=1, class_="form-control") }}
			</div>		
			<div class="form-group">
				Statut du constat <br>
				{{ form.statut(size=1, class_="form-control") }}
			</div>
			<div class="form-group">
				Localisation du constat <br>
				{{ form.localisation(size=1, class_="form-control") }}
			</div>		
			<div class="form-group">
				Secteur du constat <br>
				{{ form.secteur(size=1, class_="form-control") }}
			</div>	
			<div class="form-group">
				Commune du constat <br>
				{{ form.commune(size=1, class_="form-control") }}
			</div>								
			<div class="form-group"><button id="subform" type="submit" formaction="{{url_for('routes.map')}}" class="btn btn-primary">Filtrer les données</button></div>
			<div class="form-group"><button type="submit" formaction="{{url_for('routes.download')}}" class="btn btn-secondary">Télécharger les données</button></div>
			
		</form>
		<br>
		<table class="table table-striped table-hover">
			<thead>
				<tr>
					<th>Date attaque</th>
					<th>Type d'animaux</th>
					<th></th>
					<th></th>
					<th></th>
				</th>
			</thead>
			<tbody>
				
		{% for constat in constats %}
		<tr class="clickable" data-toggle="collapse" name="dataBouton" data-target="#textConstat{{constat.properties.id_constat}}">
			<td>
				<span  >
					{{constat.properties.date_attaque}}
				</span>

			</td>
			<td> {{ constat.properties.type_animaux_rel.nom }}</td>
			<td>
				<a title="Supprimer le constat" href="{{url_for('routes.delete',idc=constat.properties.id_constat)}}" id="delete{{constat.properties.id_constat}}">
					<i class="fas fa-trash float-right" style="margin:3px;"></i>
				</a> 
			</td>
			<td>
				<a title="Modifier le constat" href="{{url_for('routes.form',idc=constat.properties.id_constat)}}" id="update{{constat.properties.id_constat}}">
					<i class="far fa-edit float-right" style="margin:3px;"></i>
				</a> 
			</td>
			<td>
				<a title="Afficher le constat" href="{{url_for('routes.constat',idc=constat.properties.id_constat)}}">
					<i class="fas fa-info-circle float-right" style="margin:3px;"></i>
				</a>
			</td>

			<td colspan="3">
				<div class="collapse" id="textConstat{{constat.properties.id_constat}}" >
					Numéro : {{constat.properties.id_constat}} <br>
					Date de l'attaque : {{constat.properties.date_attaque}} <br>
					Date du constat : {{constat.properties.date_constat}}<br>
					Nombre de victimes (morts) : {{ constat.properties.nb_victimes_mort }}<br>
					Nombre de victimes (blessés) : {{ constat.properties.nb_victimes_blesse }}<br>
					Nom du 1er agent recenseur : {{ constat.properties.nom_agent1 }}<br>
					Nom du 2ème agent recenseur : {{ constat.properties.nom_agent2 }}<br>
					Propriétaire : {{ constat.properties.proprietaire }}<br>
					Type d'animaux : {{ constat.properties.type_animaux_rel.nom }}<br>
					Secteur : {{constat.properties.secteur.area_name}}<br>
					Commune : {{constat.properties.commune.area_name}}<br>
					Département : {{constat.properties.departement}}<br>
					Localisation : {{constat.properties.localisation}}<br>
					Créateur du constat : {{constat.properties.digitizer.nom_complet}}<br>
					Statut : {{ constat.properties.statut_rel.nom }}<br>
					Nombre de jours agent : {{constat.properties.nb_jour_agent}}<br>
				</div>
			</td>
		</tr>

		{%endfor%}
		</tbody>
	</table>
	</div>
	<div id="map"></div>
</div>
    <script>
        // CONFIGURATION DE LA CARTE //
        var map = L.map('map').setView([44.8, 6.2], 10);
        L.tileLayer('https://a.tile.opentopomap.org/{z}/{x}/{y}.png', {
	    attribution: 'Map data: &copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors, SRTM | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (CC-BY-SA)'
        }).addTo(map); 
        // ACTIONS SUR LA CARTE
        function changeZoom() {
            map.setZoom(10);
            map.setView([44.8, 6.2]);   
        }     
        var jsonData = [
			{% for constats in constats %}
				{
				'id_constat':'{{constats.properties.id_constat}}',
				'date_attaque': '{{ constats.properties.date_attaque }}',
				'date_constat': '{{ constats.properties.date_constat }}',
				'nb_victimes_mort': '{{ constats.properties.nb_victimes_mort }}',
				'nb_victimes_blesse': '{{ constats.properties.nb_victimes_blesse }}',
				'nom_agent1': '{{ constats.properties.nom_agent1 }}',
				'nom_agent2': '{{ constats.properties.nom_agent2 }}',
				'proprietaire': '{{ constats.properties.proprietaire }}',
				'type_animaux': '{{ constats.properties.type_animaux }}',
				'statut': '{{ constats.properties.statut }}',
				'secteur':'{{constats.properties.secteur}}',
				'commune':'{{constats.properties.commune}}',
				'departement':'{{constats.properties.departement}}',
				'localisation':'{{constats.properties.localisation}}',
				'nb_jour_agent': '{{ constats.properties.nb_jour_agent }}',
				'digitizer': '{{ constats.properties.digitizer.nom_complet }}',
				'geometry': '{{ constats.geometry | tojson}}'
				},
			{% endfor %}
        ]
		var markersCluster = new L.MarkerClusterGroup({
		    iconCreateFunction: function(cluster) {
				return L.divIcon({ 
					html: cluster.getChildCount(), 
					className: 'mycluster', 
					iconSize: null 
				});
			}
		});
		map.addLayer(markersCluster);
        var addMarkers = function(point) {
            var markerC=L.marker([JSON.parse(point.geometry).coordinates[1],JSON.parse(point.geometry).coordinates[0]]) 
				.bindPopup("Constat numéro : "+point.id_constat+"<br>"+ 
					"Date de l'attaque : "+point.date_attaque+"<br>"+ 
				    "Date du constat : "+point.date_constat+"<br>"+ 
					"Nombre de victimes (mort) : "+point.nb_victimes_mort+"<br>"+ 
					"Nombre de victimes (blessé) : "+point.nb_victimes_blesse+"<br>"+ 
					"Nom du 1er agent recenseur : "+point.nom_agent1+"<br>"+ 
					"Nom du 2eme agent recenseur : "+point.nom_agent2+"<br>"+ 
					"Propriétaire : "+point.proprietaire+"<br>"+ 
					"Type d'animaux : "+point.type_animaux+"<br>"+ 
					"Secteur : "+point.secteur+"<br>"+
					"Commune : "+point.commune+"<br>"+
					"Département : "+point.departement+"<br>"+
					"Localisation : "+point.localisation+"<br>"+
					"Créateur du constat : "+point.digitizer.nom_complet+"<br>"+
					"Statut : "+point.statut+"<br>" +
					"Nombre de jours agent : "+point.nb_jour_agent+"<br>"			
					) ;
					
				markersCluster.addLayer(markerC); 
        };
        jsonData.forEach(addMarkers);
		//CONSERVER LES DONNEES SAISIES DANS LE FORMULAIRE DE FILTRAGE
		const queryString = window.location.search;
		const urlParams = new URLSearchParams(queryString);
		const date = urlParams.get('date');
		if(date != null){
			document.getElementById("date").value=date;
		}
		const animaux = urlParams.get('animaux');
		if(animaux != null){
			document.getElementById("animaux").value=animaux;
		}
		const statut = urlParams.get('statut');
		if(statut != null){
			document.getElementById("statut").value=statut;
		}		
		const localisation = urlParams.get('localisation');
		if(localisation != null){
			document.getElementById("localisation").value=localisation;
		}
		const secteur = urlParams.get('secteur');
		if(secteur != null){
			document.getElementById("secteur").value=secteur;
		}
		const commune = urlParams.get('commune');
		if(commune != null){
			document.getElementById("commune").value=commune;
		}				
	</script>
{% endblock %}
